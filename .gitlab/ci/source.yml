variables:
  DEBFULLNAME: "Garden Linux builder"
  DEBEMAIL: "contact@gardenlinux.io"
  SOURCE_NAME: $CI_PROJECT_NAME
  SOURCE_DIST: bookworm

source:
  stage: source
  image: debian:bookworm-slim

  variables:
    SOURCES_LIST: |
      deb http://deb.debian.org/debian bookworm main
      deb http://deb.debian.org/debian-security bookworm-security main
      deb-src http://deb.debian.org/debian bullseye main
      deb-src http://deb.debian.org/debian-security bullseye-security main
      deb-src http://deb.debian.org/debian bookworm main
      deb-src http://deb.debian.org/debian-security bookworm-security main
      deb-src http://deb.debian.org/debian sid main
      deb-src http://deb.debian.org/debian experimental main

  before_script:
  - >
    if [[ $CI_DISPOSABLE_ENVIRONMENT ]]; then
      echo -n "$SOURCES_LIST" > /etc/apt/sources.list
      apt-get update -qy
      apt-get install -qy --no-install-recommends git build-essential devscripts curl
    fi
  - >
    if [[ $CI_COMMIT_TAG ]]; then
      SOURCE_VERSION=${CI_COMMIT_TAG#*/}
      APT_NAME=${SOURCE_NAME}=${SOURCE_VERSION%garden*}
    else
      APT_NAME=${SOURCE_NAME}/${SOURCE_DIST}
    fi

  script:
  - source_dir=$(pwd)
  - mkdir _output
  - cd _output
  - repo="https://github.com/aws/aws-sdk-cpp.git"
  - version=1.9.303
  - patch="https://patch-diff.githubusercontent.com/raw/aws/aws-sdk-cpp/pull/1986.patch"
  - repo_name="$(basename "$repo" .git)"
  - git clone --depth=1 --recurse-submodules -b "$version" "$repo"
  - cd "$repo_name"
  - curl -sSL "$patch" | git apply
  - git config core.quotepath off
  - git ls-files --recurse-submodules | tar cJf "../${repo_name}_$version.orig.tar.xz" --transform 's#^#'"$repo_name-$version"'/#S' --verbatim-files-from -T-
  - cd ..
  - rm -rf "$repo_name"
  - tar xJf "${repo_name}_$version.orig.tar.xz"
  - cp -r "$source_dir/debian" "$repo_name-$version/"
  - cd "$repo_name-$version/"
  - dpkg-buildpackage -us -uc -S -nc -d

  artifacts:
    paths:
    - _output/*.changes
    - _output/*.dsc
    - _output/*.tar.*
    expire_in: 1 week
